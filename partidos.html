<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise por Partidos - PEC da Bandidagem | Câmara dos Deputados</title>
    <meta name="description" content="Análise detalhada dos 20 partidos que votaram na PEC da Bandidagem. Veja coesão partidária, correlação com voto secreto e rankings de aprovação por partido.">
    <meta name="keywords" content="partidos políticos, PL, PT, PSDB, coesão partidária, voto secreto, PEC da Bandidagem">
    <meta property="og:title" content="Análise por Partidos - PEC da Bandidagem">
    <meta property="og:description" content="Descubra como cada partido político se posicionou na PEC da Bandidagem. Análise de coesão e padrões de votação.">
    <meta property="og:url" content="https://pec-bandidagem.vercel.app/partidos.html">
    <link rel="canonical" href="https://pec-bandidagem.vercel.app/partidos.html">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P47CK1TDL8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-P47CK1TDL8', {
        send_page_view: true,
        page_title: 'PEC da Bandidagem - Análise por Partidos',
        content_group1: 'Partido Analysis',
        content_group2: 'Political Analysis'
      });

      // Visualization tracking functions
      function trackVisualizationInteraction(chartType, action, details) {
        gtag('event', 'visualization_interaction', {
          chart_type: chartType,
          interaction_action: action,
          interaction_details: details,
          event_category: 'Data Visualization',
          event_label: `${chartType}_${action}`,
          page_type: 'partidos'
        });
      }

      function trackPartyAnalysis(partyName, analysisType) {
        gtag('event', 'party_analysis', {
          party_name: partyName,
          analysis_type: analysisType,
          event_category: 'Political Analysis',
          event_label: `Party_${partyName}`,
          value: 1
        });
      }

      // Track page engagement
      let startTime = Date.now();
      window.addEventListener('beforeunload', function() {
        gtag('event', 'page_engagement', {
          time_spent: Math.round((Date.now() - startTime) / 1000),
          page_type: 'partidos',
          event_category: 'Content Performance'
        });
      });
    </script>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
            font-weight: 500;
            /* Mobile-first: prevent horizontal scroll and smooth experience */
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            padding: 1.5rem 1rem;
            box-shadow: 0 8px 40px rgba(0,0,0,0.15);
            border-bottom: 4px solid #4f46e5;
            border-radius: 0 0 24px 24px;
            border-left: 1px solid rgba(255,255,255,0.8);
            border-right: 1px solid rgba(255,255,255,0.8);
        }

        .header h1 {
            font-size: 1.8rem;
            color: #0f172a;
            margin-bottom: 0.5rem;
            text-align: center;
            line-height: 1.2;
            font-weight: 800;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1rem;
            color: #334155;
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* Tablet and up */
        @media (min-width: 768px) {
            .header {
                padding: 2rem;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .header p {
                font-size: 1.1rem;
            }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            .header h1 {
                font-size: 2.5rem;
            }

            .header p {
                font-size: 1.2rem;
            }
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Tablet and up */
        @media (min-width: 768px) {
            .nav {
                gap: 1rem;
                flex-wrap: nowrap;
            }
        }

        .nav a {
            padding: 0.6rem 1rem;
            background: #4f46e5;
            color: white;
            text-decoration: none;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* Tablet and up */
        @media (min-width: 768px) {
            .nav a {
                padding: 0.75rem 1.5rem;
                border-radius: 25px;
                font-size: 1rem;
            }
        }

        .nav a:hover, .nav a.active {
            background: #3730a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .container {
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Tablet and up */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                padding: 1.5rem;
            }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            .container {
                max-width: 1400px;
                padding: 2rem;
            }
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            /* Ensure charts don't overflow on mobile */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Tablet and up */
        @media (min-width: 768px) {
            .chart-container {
                border-radius: 20px;
                padding: 1.5rem;
                margin: 1.5rem 0;
                overflow-x: visible;
            }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            .chart-container {
                padding: 2rem;
                margin: 2rem 0;
            }
        }

        .chart-title {
            font-size: 1.8rem;
            color: #1a202c;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 800;
            letter-spacing: -0.025em;
        }

        .chart-subtitle {
            font-size: 1rem;
            color: #2d3748;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 600;
        }

        .tooltip {
            position: absolute;
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .bar:hover {
            stroke: #1e293b;
            stroke-width: 2;
        }

        .axis {
            font-size: 12px;
            color: #64748b;
        }

        .axis-label {
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #4f46e5;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4f46e5;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .control-button {
            padding: 0.5rem 1rem;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .control-button:hover, .control-button.active {
            background: #4f46e5;
            color: white;
        }

        /* GitHub fork ribbon - classic style */
        .github-fork-ribbon {
            width: 12.1em;
            height: 12.1em;
            position: fixed;
            overflow: hidden;
            top: 0;
            right: 0;
            z-index: 9999;
            pointer-events: none;
            font-size: 13px;
            text-decoration: none;
            text-indent: -999999px;
            opacity: 0.9;
        }

        .github-fork-ribbon:hover, .github-fork-ribbon:active {
            background-color: rgba(0, 0, 0, 0.0);
        }

        .github-fork-ribbon:before, .github-fork-ribbon:after {
            position: absolute;
            display: block;
            width: 15.38em;
            height: 1.54em;
            top: 3.23em;
            right: -3.23em;
            box-sizing: content-box;
            transform: rotate(45deg);
        }

        .github-fork-ribbon:before {
            content: "";
            padding: .38em 0;
            background-color: #a00;
            background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
            box-shadow: 0 .15em .23em 0 rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }

        .github-fork-ribbon:after {
            content: attr(data-ribbon);
            color: #fff;
            font: 700 1em "Helvetica Neue", Helvetica, Arial, sans-serif;
            line-height: 1.54em;
            text-decoration: none;
            text-shadow: 0 -.08em rgba(0, 0, 0, 0.5);
            text-align: center;
            text-indent: 0;
            padding: .15em 0;
            margin: .15em 0;
            border-width: .08em 0;
            border-style: dotted;
            border-color: #fff;
            border-color: rgba(255, 255, 255, 0.7);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .nav {
                flex-direction: column;
                align-items: center;
            }

            .container {
                padding: 1rem;
            }

            .legend {
                flex-direction: column;
                align-items: center;
            }

            .github-fork-ribbon {
                font-size: 11px;
                opacity: 0.8;
            }
        }
        /* Mobile landscape optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 0.3rem;
            }

            .header p {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            .nav {
                gap: 0.3rem;
                margin-top: 0.5rem;
            }

            .nav a {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            .container {
                padding: 0.5rem;
            }

            .chart-container {
                padding: 0.8rem;
                margin: 0.5rem 0;
            }

            .chart-title {
                font-size: 1.3rem;
                margin-bottom: 0.5rem;
            }

            .chart-subtitle {
                font-size: 0.85rem;
                margin-bottom: 1rem;
            }
        }

        /* Small mobile optimizations */
        @media (max-width: 480px) {
            .chart-title {
                font-size: 1.4rem;
            }

            .chart-subtitle {
                font-size: 0.9rem;
            }

            /* Make tooltips larger for touch */
            .tooltip {
                font-size: 12px !important;
                padding: 10px !important;
                min-width: 200px !important;
            }

            /* GitHub fork ribbon mobile adjustment */
            .github-fork-ribbon {
                font-size: 10px;
                opacity: 0.8;
            }
        }

        /* Touch improvements for interactive elements */
        @media (hover: none) and (pointer: coarse) {
            .control-button {
                min-height: 44px;
                padding: 0.8rem 1.2rem;
                font-size: 1rem;
            }

            .nav a {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Larger touch targets for chart elements */
            .legend-item {
                padding: 0.5rem;
                margin: 0.25rem;
            }
        }

        .breadcrumb {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .breadcrumb a {
            color: #4f46e5;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb span {
            margin: 0 0.5rem;
            color: #64748b;
        }

        .footer {
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 2rem;
            margin-top: 4rem;
            text-align: center;
        }
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        .footer h3 {
            margin-bottom: 1rem;
            color: #e2e8f0;
        }
        .footer p {
            color: #94a3b8;
            line-height: 1.6;
        }
        .data-sources {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .source-link {
            color: #60a5fa;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .source-link:hover {
            color: #93c5fd;
        }
    </style>
</head>
<body>
    <!-- GitHub Fork Ribbon -->
    <a class="github-fork-ribbon" href="https://github.com/fcavalcantirj/pec-bandidagem" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>

    <div class="header">
        <h1>🏛️ PEC da Bandidagem</h1>
        <p>⚠️ ALERTA: Análise dos Partidos que Aprovaram a PEC</p>
        <nav class="nav">
            <a href="index.html">🏠 Início</a>
            <a href="deputados.html">👥 Deputados</a>
            <a href="partidos.html" class="active">🎯 Partidos</a>
            <a href="estados.html">🗺️ Estados</a>
            <a href="fluxo.html">🔄 Fluxo</a>
            <a href="relatorio.html">📋 Relatório</a>
            <a href="despesas.html">💰 Despesas</a>
        </nav>
    </div>

    <div class="breadcrumb">
        <a href="index.html">🏠 Início</a>
        <span>›</span>
        <span>📊 Análise por Partidos</span>
        <span>•</span>
        <a href="estados.html">🗺️ Estados</a>
        <span>•</span>
        <a href="deputados.html">👥 Deputados</a>
        <span>•</span>
        <a href="fluxo.html">🔄 Fluxo de Votos</a>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card" style="border-left-color: #dc2626; background: rgba(255, 255, 255, 0.98);">
                <div class="stat-number" id="total-parties" style="color: #dc2626;">20</div>
                <div class="stat-label" style="color: #991b1b; font-weight: 700;">Partidos que Votaram SIM</div>
            </div>
            <div class="stat-card" style="border-left-color: #dc2626; background: rgba(255, 255, 255, 0.98);">
                <div class="stat-number" id="unanimous-parties" style="color: #dc2626;">7</div>
                <div class="stat-label" style="color: #991b1b; font-weight: 700;">Partidos 100% A FAVOR</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="split-parties">9</div>
                <div class="stat-label">Partidos Divididos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-cohesion">76%</div>
                <div class="stat-label">Coesão Média</div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title" style="color: #dc2626;">🚨 Partidos que Aprovaram a PEC - 2º Turno</h2>
            <p class="chart-subtitle" style="color: #7f1d1d; font-weight: 600;">⚠️ Percentual de deputados que votaram SIM por partido</p>

            <div class="controls">
                <button class="control-button active" onclick="sortBy('approval')">Ordenar por Aprovação</button>
                <button class="control-button" onclick="sortBy('cohesion')">Ordenar por Coesão</button>
                <button class="control-button" onclick="sortBy('size')">Ordenar por Tamanho</button>
            </div>

            <svg id="party-chart" width="100%" height="500" role="img" aria-labelledby="party-chart-title" aria-describedby="party-chart-desc">
                <title id="party-chart-title">Gráfico de Aprovação por Partido Político</title>
                <desc id="party-chart-desc">Gráfico de barras horizontais mostrando a porcentagem de aprovação da PEC da Bandidagem por partido político, ordenado por aprovação decrescente</desc>
            </svg>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #7c2d12;"></div>
                    <span style="color: #7c2d12; font-weight: 600;">🚨 Aprovação Massiva (≥90%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc2626;"></div>
                    <span style="color: #dc2626; font-weight: 600;">⚠️ Aprovação Alta (80-89%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ea580c;"></div>
                    <span style="color: #ea580c; font-weight: 600;">⚠️ Aprovação Moderada-Alta (70-79%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d97706;"></div>
                    <span style="color: #d97706;">Aprovação Moderada (50-69%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ca8a04;"></div>
                    <span style="color: #ca8a04;">Baixa Aprovação (30-49%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2563eb;"></div>
                    <span style="color: #2563eb; font-weight: 600;">✅ Oposição (10-29%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1e40af;"></div>
                    <span style="color: #1e40af; font-weight: 600;">✅ Oposição Forte (<10%)</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">🎯 Coesão Partidária (Índice Rice)</h2>
            <p class="chart-subtitle">Medida de disciplina interna do partido (100% = unanimidade)</p>

            <svg id="cohesion-chart" width="100%" height="400" role="img" aria-labelledby="cohesion-chart-title" aria-describedby="cohesion-chart-desc">
                <title id="cohesion-chart-title">Gráfico de Coesão Partidária</title>
                <desc id="cohesion-chart-desc">Gráfico de barras horizontais mostrando o índice Rice de coesão partidária, medindo a disciplina interna de cada partido na votação da PEC</desc>
            </svg>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">🔐 Correlação: Voto vs Defesa do Voto Secreto</h2>
            <p class="chart-subtitle">Partidos que votaram SIM tendem a defender voto secreto</p>

            <svg id="correlation-chart" width="100%" height="400"></svg>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script src="data.js"></script>
    <script>
        // Use embedded data to avoid CORS issues
        function loadData() {
            const data = VISUALIZATION_DATA;

            // Convert party data to array and calculate metrics
            const parties = Object.entries(data.parties).map(([name, stats]) => ({
                name: name,
                round1_approval: stats.round1_approval,
                round2_approval: stats.round2_approval,
                cohesion: stats.cohesion,
                size: stats.round2_total,
                sim_votes: stats.round2.Sim,
                nao_votes: stats.round2.Não,
                secret_defense: stats.secret_defense_pct
            })).filter(d => d.size > 0);

            // Color scale: Green/Blue for low approval (good), Yellow/Red for high approval (concerning)
            function getPartyColor(approval) {
                if (approval >= 90) return '#7c2d12'; // Dark brown - Massive approval (very concerning)
                if (approval >= 80) return '#dc2626'; // Dark red - High approval (concerning)
                if (approval >= 70) return '#ea580c'; // Orange - Moderate-high approval (concerning)
                if (approval >= 50) return '#d97706'; // Amber - Moderate approval (concerning)
                if (approval >= 30) return '#ca8a04'; // Yellow - Low-moderate approval (better)
                if (approval >= 10) return '#2563eb'; // Blue - Low approval (good)
                return '#1e40af'; // Dark blue - Very low approval (excellent)
            }

            let currentSort = 'approval';

            function sortBy(type) {
                currentSort = type;

                // Update button states
                d3.selectAll('.control-button').classed('active', false);
                d3.select(`[onclick="sortBy('${type}')"]`).classed('active', true);

                let sortedParties;
                switch(type) {
                    case 'approval':
                        sortedParties = [...parties].sort((a, b) => b.round2_approval - a.round2_approval);
                        break;
                    case 'cohesion':
                        sortedParties = [...parties].sort((a, b) => b.cohesion - a.cohesion);
                        break;
                    case 'size':
                        sortedParties = [...parties].sort((a, b) => b.size - a.size);
                        break;
                }

                updatePartyChart(sortedParties);
            }

            function updatePartyChart(sortedParties) {
                const svg = d3.select('#party-chart');
                const container = svg.node().parentNode;
                const containerWidth = container.clientWidth - (isMobile() ? 20 : 40);
                const margin = getMobileMargins();
                const width = Math.max(280, containerWidth - margin.left - margin.right);
                const height = getMobileHeight() - margin.top - margin.bottom;

                svg.attr('width', containerWidth).attr('height', getMobileHeight());
                svg.selectAll('*').remove();

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Scales
                const x = d3.scaleLinear()
                    .domain([0, 100])
                    .range([0, width]);

                const y = d3.scaleBand()
                    .domain(sortedParties.map(d => d.name))
                    .range([0, height])
                    .padding(0.1);

                // Axes
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => d + '%'));

                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(y));

                // Bars
                g.selectAll('.bar')
                    .data(sortedParties)
                    .enter().append('rect')
                    .attr('class', 'bar')
                    .attr('x', 0)
                    .attr('y', d => y(d.name))
                    .attr('width', 0)
                    .attr('height', y.bandwidth())
                    .attr('fill', d => getPartyColor(d.round2_approval))
                    .attr('rx', 4)
                    .on('mouseover', function(event, d) {
                        const tooltip = d3.select('#tooltip');
                        tooltip.style('opacity', 1)
                            .html(`
                                <strong>${d.name}</strong><br/>
                                Aprovação: ${d.round2_approval.toFixed(1)}%<br/>
                                Votos SIM: ${d.sim_votes}/${d.size}<br/>
                                Coesão: ${d.cohesion.toFixed(1)}%<br/>
                                Defesa Voto Secreto: ${d.secret_defense.toFixed(1)}%
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select('#tooltip').style('opacity', 0);
                    })
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 50)
                    .attr('width', d => x(d.round2_approval));

                // Add percentage labels
                g.selectAll('.bar-label')
                    .data(sortedParties)
                    .enter().append('text')
                    .attr('class', 'bar-label')
                    .attr('x', d => x(d.round2_approval) + 5)
                    .attr('y', d => y(d.name) + y.bandwidth()/2)
                    .attr('dy', '0.35em')
                    .style('font-size', '12px')
                    .style('fill', '#1e293b')
                    .style('font-weight', '500')
                    .style('opacity', 0)
                    .text(d => d.round2_approval.toFixed(1) + '%')
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 50 + 500)
                    .style('opacity', 1);
            }

            function createCohesionChart() {
                const svg = d3.select('#cohesion-chart');
                const container = svg.node().parentNode;
                const containerWidth = container.clientWidth - (isMobile() ? 20 : 40);
                const margin = getMobileMargins();
                const width = Math.max(280, containerWidth - margin.left - margin.right);
                const chartHeight = isMobile() ? 350 : 400;
                const height = chartHeight - margin.top - margin.bottom;

                svg.attr('width', containerWidth).attr('height', chartHeight);

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                const sortedByCohesion = [...parties].sort((a, b) => b.cohesion - a.cohesion);

                // Scales
                const x = d3.scaleLinear()
                    .domain([0, 100])
                    .range([0, width]);

                const y = d3.scaleBand()
                    .domain(sortedByCohesion.map(d => d.name))
                    .range([0, height])
                    .padding(0.1);

                // Color scale for cohesion
                const cohesionColor = d3.scaleLinear()
                    .domain([0, 50, 100])
                    .range(['#ef4444', '#f59e0b', '#10b981']);

                // Axes
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => d + '%'));

                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(y));

                // Bars
                g.selectAll('.cohesion-bar')
                    .data(sortedByCohesion)
                    .enter().append('rect')
                    .attr('class', 'cohesion-bar')
                    .attr('x', 0)
                    .attr('y', d => y(d.name))
                    .attr('width', 0)
                    .attr('height', y.bandwidth())
                    .attr('fill', d => cohesionColor(d.cohesion))
                    .attr('rx', 4)
                    .on('mouseover', function(event, d) {
                        const tooltip = d3.select('#tooltip');
                        tooltip.style('opacity', 1)
                            .html(`
                                <strong>${d.name}</strong><br/>
                                Coesão: ${d.cohesion.toFixed(1)}%<br/>
                                Disciplina: ${d.cohesion > 90 ? 'Muito Alta' :
                                            d.cohesion > 70 ? 'Alta' :
                                            d.cohesion > 50 ? 'Média' : 'Baixa'}
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select('#tooltip').style('opacity', 0);
                    })
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 50)
                    .attr('width', d => x(d.cohesion));
            }

            function createCorrelationChart() {
                const svg = d3.select('#correlation-chart');
                const container = svg.node().parentNode;
                const containerWidth = container.clientWidth - (isMobile() ? 20 : 40);
                const margin = isMobile() ?
                    {top: 15, right: 15, bottom: 50, left: 50} :
                    {top: 20, right: 30, bottom: 60, left: 60};
                const width = Math.max(250, containerWidth - margin.left - margin.right);
                const chartHeight = isMobile() ? 300 : 400;
                const height = chartHeight - margin.top - margin.bottom;

                svg.attr('width', containerWidth).attr('height', chartHeight);

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Scales
                const x = d3.scaleLinear()
                    .domain([0, 100])
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain([0, 100])
                    .range([height, 0]);

                const radius = d3.scaleSqrt()
                    .domain([0, d3.max(parties, d => d.size)])
                    .range([3, 20]);

                // Axes
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => d + '%'));

                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(y).tickFormat(d => d + '%'));

                // Axis labels
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', `translate(${width/2},${height + 40})`)
                    .style('text-anchor', 'middle')
                    .text('Aprovação da PEC (%)');

                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', -40)
                    .attr('x', -height/2)
                    .style('text-anchor', 'middle')
                    .text('Defesa do Voto Secreto (%)');

                // Circles
                g.selectAll('.correlation-circle')
                    .data(parties.filter(d => d.secret_defense !== null && !isNaN(d.secret_defense)))
                    .enter().append('circle')
                    .attr('class', 'correlation-circle')
                    .attr('cx', d => x(d.round2_approval))
                    .attr('cy', d => y(d.secret_defense))
                    .attr('r', 0)
                    .attr('fill', d => getPartyColor(d.round2_approval))
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        const tooltip = d3.select('#tooltip');
                        tooltip.style('opacity', 1)
                            .html(`
                                <strong>${d.name}</strong><br/>
                                Aprovação PEC: ${d.round2_approval.toFixed(1)}%<br/>
                                Defesa Voto Secreto: ${d.secret_defense.toFixed(1)}%<br/>
                                Tamanho: ${d.size} deputados
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select('#tooltip').style('opacity', 0);
                    })
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 100)
                    .attr('r', d => radius(d.size));

                // Trend line (simple linear regression)
                const validParties = parties.filter(d => d.secret_defense !== null && !isNaN(d.secret_defense));
                if (validParties.length > 1) {
                    const xMean = d3.mean(validParties, d => d.round2_approval);
                    const yMean = d3.mean(validParties, d => d.secret_defense);

                    let numerator = 0, denominator = 0;
                    validParties.forEach(d => {
                        numerator += (d.round2_approval - xMean) * (d.secret_defense - yMean);
                        denominator += (d.round2_approval - xMean) ** 2;
                    });

                    const slope = numerator / denominator;
                    const intercept = yMean - slope * xMean;

                    const lineData = [
                        {x: 0, y: intercept},
                        {x: 100, y: slope * 100 + intercept}
                    ];

                    const line = d3.line()
                        .x(d => x(d.x))
                        .y(d => y(d.y));

                    g.append('path')
                        .datum(lineData)
                        .attr('fill', 'none')
                        .attr('stroke', '#1e293b')
                        .attr('stroke-width', 2)
                        .attr('stroke-dasharray', '5,5')
                        .attr('opacity', 0)
                        .attr('d', line)
                        .transition()
                        .duration(1500)
                        .delay(1000)
                        .attr('opacity', 0.6);
                }
            }

            // Initialize charts
            const sortedParties = [...parties].sort((a, b) => b.round2_approval - a.round2_approval);
            updatePartyChart(sortedParties);
            createCohesionChart();
            createCorrelationChart();

            // Make sortBy function global
            window.sortBy = sortBy;

            // Update stats
            document.getElementById('total-parties').textContent = parties.length;
            document.getElementById('unanimous-parties').textContent = parties.filter(p => p.cohesion === 100).length;
            document.getElementById('split-parties').textContent = parties.filter(p => p.cohesion < 70).length;
            document.getElementById('avg-cohesion').textContent = Math.round(d3.mean(parties, d => d.cohesion)) + '%';
        }

        // Initialize when page loads
        loadData();

        // Enhanced responsive handling
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Reload charts on resize with debouncing
                loadData();
            }, 250);
        });

        // Mobile-specific chart optimizations
        function isMobile() {
            return window.innerWidth <= 768;
        }

        function getMobileMargins() {
            if (window.innerWidth <= 480) {
                return {top: 15, right: 15, bottom: 60, left: 80};
            } else if (window.innerWidth <= 768) {
                return {top: 20, right: 20, bottom: 70, left: 100};
            }
            return {top: 20, right: 30, bottom: 80, left: 120};
        }

        function getMobileHeight() {
            if (window.innerWidth <= 480) {
                return 350;
            } else if (window.innerWidth <= 768) {
                return 400;
            }
            return 500;
        }

        // Orientation change handling
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                loadData();
            }, 500);
        });
    </script>

    <div class="footer" style="background: rgba(30, 41, 59, 0.95); color: white; padding: 2rem; margin-top: 3rem; text-align: center;">
        <div class="footer-content" style="max-width: 1200px; margin: 0 auto;">
            <div id="version-info" style="margin: 1rem 0; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                <!-- Version info will be injected here by version.js -->
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #94a3b8;">
                <a href="index.html" style="color: #3b82f6; text-decoration: none;">← Voltar ao início</a> |
                Criado por <a href="https://github.com/fcavalcantirj" style="color: #3b82f6; text-decoration: none;">fcavalcantirj</a>
            </p>
        </div>
    </div>

    <script src="version.js"></script>

    <div class="footer">
        <div class="footer-content">
            <h3>🔬 Transparência e Reprodutibilidade</h3>
            <p>
                Esta análise foi desenvolvida com foco na transparência e precisão dos dados.
                Todos os números foram verificados independentemente e estão prontos para publicação acadêmica ou jornalística.
            </p>
            <div class="data-sources">
                <a href="docs/RELATORIO_PEC_BANDIDAGEM.md" class="source-link">📄 Relatório Completo</a>
                <a href="docs/VALIDATION_REPORT.md" class="source-link">✅ Relatório de Validação</a>
                <a href="docs/DEVELOPMENT.md" class="source-link">🛠️ Documentação Técnica</a>
                <a href="https://www.reddit.com/r/brasil/comments/1niy6g4/c%C3%A2mara_aprova_pec_da_blindagem_em_1%C2%BA_turno/" class="source-link" target="_blank">📝 Post Original</a>
            </div>
            <div id="version-info" style="margin-top: 2rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                <!-- Version info will be injected here by version.js -->
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #94a3b8;">
                <a href="index.html" class="source-link">← Voltar ao Início</a> | Criado por <a href="https://github.com/fcavalcantirj" class="source-link">fcavalcantirj</a> •
                Análise gerada em setembro de 2025 • Dados validados para publicação pública
            </p>
        </div>
    </div>

    <script src="version.js"></script>
</body>
</html>