<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despesas dos Deputados - PEC da Bandidagem | Transpar√™ncia</title>
    <meta name="description" content="An√°lise completa das despesas parlamentares dos deputados que votaram na PEC da Bandidagem. Transpar√™ncia total dos gastos p√∫blicos com dados oficiais da C√¢mara dos Deputados.">
    <meta name="keywords" content="despesas parlamentares, gastos deputados, transpar√™ncia, PEC bandidagem, cota parlamentar, gastos p√∫blicos">
    <meta property="og:title" content="Despesas dos Deputados - PEC da Bandidagem">
    <meta property="og:description" content="An√°lise completa das despesas parlamentares dos deputados que votaram na PEC da Bandidagem.">
    <meta property="og:url" content="https://pec-bandidagem.vercel.app/despesas.html">
    <link rel="canonical" href="https://pec-bandidagem.vercel.app/despesas.html">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P47CK1TDL8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-P47CK1TDL8');
    </script>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
            font-weight: 500;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            padding: 1.5rem 1rem;
            box-shadow: 0 8px 40px rgba(0,0,0,0.15);
            border-bottom: 4px solid #4f46e5;
            border-radius: 0 0 24px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.8rem;
            color: #0f172a;
            margin-bottom: 0.5rem;
            text-align: center;
            line-height: 1.2;
            font-weight: 800;
        }

        .header p {
            font-size: 1rem;
            color: #334155;
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .nav a {
            padding: 0.6rem 1rem;
            background: #4f46e5;
            color: white;
            text-decoration: none;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .nav a:hover, .nav a.active {
            background: #3730a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .chart-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .chart-description {
            color: #64748b;
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #4f46e5;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .deputy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
            min-height: 200px;
        }

        .deputy-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.5s ease forwards;
        }

        .deputy-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .deputy-card.loading {
            opacity: 0.7;
        }

        .deputy-card.loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4f46e5, transparent);
            animation: loading-bar 2s infinite;
        }

        @keyframes loading-bar {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .deputy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .deputy-name {
            font-weight: 700;
            color: #0f172a;
            font-size: 1.1rem;
        }

        .deputy-party {
            background: #4f46e5;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .expense-total {
            font-size: 1.5rem;
            font-weight: 800;
            color: #dc2626;
            text-align: center;
            margin-bottom: 1rem;
        }

        .expense-details {
            font-size: 0.9rem;
            color: #64748b;
            text-align: center;
        }

        .load-more-trigger {
            text-align: center;
            padding: 2rem;
            margin: 2rem 0;
        }

        .load-more-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .load-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        }

        .load-more-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .infinity-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
            color: #64748b;
            font-weight: 600;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-btn:hover, .filter-btn.active {
            border-color: #4f46e5;
            background: #4f46e5;
            color: white;
            transform: translateY(-1px);
        }

        .search-container {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .search-input {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .search-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .performance-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            z-index: 1000;
            min-width: 200px;
            display: none;
        }

        .perf-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .api-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #059669;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        .api-badge::before {
            content: "üîó";
            font-size: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #475569;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .chart-container { padding: 1.5rem; }
            .deputy-grid { grid-template-columns: 1fr; }
            .performance-indicator { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ PEC da Bandidagem</h1>
        <p>An√°lise transparente dos gastos parlamentares relacionados √† PEC da Bandidagem</p>
        <div class="nav">
            <a href="index.html">üè† In√≠cio</a>
            <a href="deputados.html">üë• Deputados</a>
            <a href="partidos.html">üéØ Partidos</a>
            <a href="estados.html">üó∫Ô∏è Estados</a>
            <a href="fluxo.html">üîÑ Fluxo</a>
            <a href="relatorio.html">üìã Relat√≥rio</a>
            <a href="despesas.html" class="active">üí∞ Despesas</a>
        </div>
    </div>

    <div class="container">
        <!-- Quick Stats -->
        <div class="chart-container">
            <h2 class="chart-title">üìä Vis√£o Geral</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-deputies">493</div>
                    <div class="stat-label">Total de Deputados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="loaded-count">0</div>
                    <div class="stat-label">Carregados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-expenses">-</div>
                    <div class="stat-label">Gastos Carregados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-expense">-</div>
                    <div class="stat-label">M√©dia por Deputado</div>
                </div>
            </div>

            <div class="api-badge">
                Dados oficiais da C√¢mara dos Deputados
            </div>
        </div>

        <!-- Expense Distribution Chart -->
        <div class="chart-container">
            <h2 class="chart-title">Distribui√ß√£o de Gastos</h2>
            <p class="chart-description">Visualiza√ß√£o dos gastos parlamentares por deputado carregado</p>

            <div class="expense-chart" id="expense-chart" style="width: 100%; height: 400px; background: rgba(255, 255, 255, 0.5); border-radius: 12px; margin: 1rem 0;"></div>
        </div>

        <!-- Deputy Search and Filter -->
        <div class="chart-container">
            <h2 class="chart-title">Deputados e Despesas</h2>
            <p class="chart-description">Encontre informa√ß√µes detalhadas sobre gastos espec√≠ficos</p>

            <div class="search-container">
                <input type="text" class="search-input" id="deputy-search" placeholder="Digite o nome do deputado para buscar...">
            </div>

            <div class="filters" id="party-filters">
                <button class="filter-btn active" data-party="all">Todos</button>
            </div>

            <div class="deputy-grid" id="deputy-grid"></div>

            <!-- Infinite Loading Trigger -->
            <div class="load-more-trigger" id="load-more-trigger">
                <div class="infinity-loading" id="infinity-loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>Carregando mais deputados...</span>
                </div>

                <button class="load-more-btn" id="manual-load-btn">
                    Carregar pr√≥ximos 10 deputados
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Indicator -->
    <div class="performance-indicator" id="performance-indicator">
        <div class="perf-line">
            <span>Carregados:</span>
            <span id="perf-loaded">0</span>
        </div>
        <div class="perf-line">
            <span>Com Despesas:</span>
            <span id="perf-with-expenses">0</span>
        </div>
        <div class="perf-line">
            <span>√öltima API:</span>
            <span id="perf-last-load">-</span>
        </div>
        <div class="perf-line">
            <span>Velocidade:</span>
            <span id="perf-speed">- req/s</span>
        </div>
    </div>

    <script>
        // Smart Scroll-Based Expense Loader
        class ScrollExpenseLoader {
            constructor() {
                this.pageSize = 10; // Load 10 deputies at a time for smoother scrolling
                this.currentPage = 0;
                this.isLoading = false;
                this.allData = [];
                this.loadedData = [];
                this.filteredData = [];
                this.currentFilter = 'all';
                this.searchQuery = '';
                this.cache = new Map();
                this.stats = {
                    loaded: 0,
                    withExpenses: 0,
                    lastLoadTime: 0,
                    startTime: Date.now()
                };

                this.setupInfiniteScroll();
                this.setupManualLoad();
                this.setupSearch();
            }

            async initialize() {
                console.log('üöÄ Initializing Smart Scroll Loader');
                await this.loadDeputyData();
                this.setupFilters();
                this.renderInitialPage();
            }

            async loadDeputyData() {
                try {
                    const response = await fetch('data.js');
                    const text = await response.text();

                    const dataMatch = text.match(/const\s+VISUALIZATION_DATA\s*=\s*(\{[\s\S]*?\});/);
                    if (dataMatch) {
                        const visualizationData = JSON.parse(dataMatch[1]);

                        let deputies = [...(visualizationData.round1 || [])];
                        if (visualizationData.round2) {
                            visualizationData.round2.forEach(deputy2 => {
                                const existingIndex = deputies.findIndex(d => d.deputado === deputy2.deputado);
                                if (existingIndex >= 0) {
                                    deputies[existingIndex] = { ...deputies[existingIndex], ...deputy2 };
                                } else {
                                    deputies.push(deputy2);
                                }
                            });
                        }

                        this.allData = deputies.map(deputy => ({
                            nome: deputy.deputado,
                            partido: deputy.partido,
                            uf: deputy.estado,
                            voto: deputy.voto,
                            totalExpense: 0,
                            expenseCount: 0,
                            loading: false,
                            loaded: false,
                            id: null,
                            expenses: [],
                            error: null
                        }));

                        this.filteredData = [...this.allData];
                        console.log(`üìã Loaded ${this.allData.length} deputies for scroll loading`);
                    }
                } catch (error) {
                    console.error('Error loading deputy data:', error);
                    this.showError('Erro ao carregar dados dos deputados: ' + error.message);
                }
            }

            setupFilters() {
                const parties = [...new Set(this.allData.map(d => d.partido))].sort();
                const filtersEl = document.getElementById('party-filters');

                parties.forEach(party => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.dataset.party = party;
                    btn.textContent = party;
                    btn.addEventListener('click', () => this.filterByParty(party));
                    filtersEl.appendChild(btn);
                });

                filtersEl.querySelector('[data-party="all"]').addEventListener('click', () => this.filterByParty('all'));
            }

            setupInfiniteScroll() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !this.isLoading) {
                            this.loadNextPage();
                        }
                    });
                }, { threshold: 0.1 });

                // Observe the load trigger
                setTimeout(() => {
                    const trigger = document.getElementById('load-more-trigger');
                    if (trigger) observer.observe(trigger);
                }, 1000);
            }

            setupManualLoad() {
                document.getElementById('manual-load-btn').addEventListener('click', () => {
                    this.loadNextPage();
                });
            }

            setupSearch() {
                const searchInput = document.getElementById('deputy-search');
                searchInput.addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    this.applyFilters();
                });
            }

            filterByParty(party) {
                // Update active filter button
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-party="${party}"]`).classList.add('active');

                this.currentFilter = party;
                this.applyFilters();
            }

            applyFilters() {
                // Reset and apply filters
                this.filteredData = this.allData.filter(deputy => {
                    const matchesParty = this.currentFilter === 'all' || deputy.partido === this.currentFilter;
                    const matchesSearch = !this.searchQuery || deputy.nome.toLowerCase().includes(this.searchQuery);
                    return matchesParty && matchesSearch;
                });

                // Reset pagination and reload
                this.currentPage = 0;
                this.loadedData = [];
                document.getElementById('deputy-grid').innerHTML = '';
                this.renderInitialPage();
            }

            renderInitialPage() {
                console.log('üì± Rendering initial page');
                this.loadNextPage();
            }

            async loadNextPage() {
                if (this.isLoading) return;

                const startIndex = this.currentPage * this.pageSize;
                const endIndex = Math.min(startIndex + this.pageSize, this.filteredData.length);

                if (startIndex >= this.filteredData.length) {
                    this.hideLoadMore();
                    return;
                }

                this.showLoading();
                this.isLoading = true;

                console.log(`üì¶ Loading page ${this.currentPage + 1}: deputies ${startIndex + 1}-${endIndex}`);

                const pageData = this.filteredData.slice(startIndex, endIndex);

                // Render cards immediately with loading state
                pageData.forEach((deputy, index) => {
                    this.renderDeputyCard(deputy, startIndex + index, true);
                });

                // Load expense data in parallel for this page
                const loadPromises = pageData.map((deputy, index) =>
                    this.loadDeputyExpenses(deputy, startIndex + index)
                );

                await Promise.allSettled(loadPromises);

                this.loadedData.push(...pageData);
                this.currentPage++;
                this.isLoading = false;
                this.hideLoading();
                this.updateStats();
                this.updateLoadMoreButton();

                console.log(`‚úÖ Page ${this.currentPage} loaded successfully`);
            }

            async loadDeputyExpenses(deputy, index) {
                if (deputy.loaded) return;

                const startTime = Date.now();
                deputy.loading = true;

                try {
                    const currentYear = new Date().getFullYear();

                    // Search for deputy (with caching)
                    let searchData;
                    if (this.cache.has(deputy.nome)) {
                        searchData = this.cache.get(deputy.nome);
                    } else {
                        const searchUrl = `https://dadosabertos.camara.leg.br/api/v2/deputados?nome=${encodeURIComponent(deputy.nome)}&ordem=ASC&ordenarPor=nome`;
                        const response = await fetch(searchUrl);
                        searchData = await response.json();
                        this.cache.set(deputy.nome, searchData);
                    }

                    if (searchData.dados && searchData.dados.length > 0) {
                        const deputyInfo = searchData.dados[0];

                        // Get expenses
                        const expenseUrl = `https://dadosabertos.camara.leg.br/api/v2/deputados/${deputyInfo.id}/despesas?ano=${currentYear}&ordem=ASC&ordenarPor=dataDocumento`;
                        const expenseResponse = await fetch(expenseUrl);
                        const expenseData = await expenseResponse.json();

                        const totalExpense = expenseData.dados.reduce((sum, expense) => {
                            return sum + (expense.valorLiquido || 0);
                        }, 0);

                        // Update deputy data
                        Object.assign(deputy, {
                            totalExpense,
                            expenseCount: expenseData.dados.length,
                            id: deputyInfo.id,
                            expenses: expenseData.dados,
                            loading: false,
                            loaded: true,
                            error: null
                        });

                        this.stats.withExpenses += totalExpense > 0 ? 1 : 0;
                        console.log(`‚úÖ ${deputy.nome}: ${this.formatCurrency(totalExpense)}`);
                    }
                } catch (error) {
                    console.warn(`‚ùå ${deputy.nome}:`, error.message);
                    Object.assign(deputy, {
                        totalExpense: 0,
                        expenseCount: 0,
                        loading: false,
                        loaded: true,
                        error: error.message
                    });
                }

                this.stats.loaded++;
                this.stats.lastLoadTime = Date.now() - startTime;
                this.updateDeputyCard(deputy, index);
                this.updatePerformanceIndicator();
            }

            renderDeputyCard(deputy, index, isLoading = false) {
                const grid = document.getElementById('deputy-grid');
                const card = document.createElement('div');
                card.className = `deputy-card ${isLoading ? 'loading' : ''}`;
                card.id = `deputy-card-${index}`;
                card.style.animationDelay = `${(index % this.pageSize) * 0.1}s`;

                const expenseDisplay = isLoading || deputy.loading ?
                    '<div style="color: #94a3b8;">‚è≥ Carregando...</div>' :
                    this.formatCurrency(deputy.totalExpense);

                const detailsDisplay = isLoading || deputy.loading ?
                    'Buscando dados de despesas...' :
                    `${deputy.expenseCount} despesas em 2025<br>Estado: ${deputy.uf || 'N/A'}`;

                card.innerHTML = `
                    <div class="deputy-header">
                        <div class="deputy-name">${deputy.nome}</div>
                        <div class="deputy-party">${deputy.partido}</div>
                    </div>
                    <div class="expense-total">${expenseDisplay}</div>
                    <div class="expense-details">${detailsDisplay}</div>
                `;

                if (!isLoading && !deputy.loading) {
                    card.addEventListener('click', () => this.showDeputyDetails(deputy));
                    card.style.cursor = 'pointer';
                }

                grid.appendChild(card);
            }

            updateDeputyCard(deputy, index) {
                const card = document.getElementById(`deputy-card-${index}`);
                if (!card) return;

                card.className = 'deputy-card';

                const expenseDisplay = this.formatCurrency(deputy.totalExpense);
                const detailsDisplay = `${deputy.expenseCount} despesas em 2025<br>Estado: ${deputy.uf || 'N/A'}`;

                card.innerHTML = `
                    <div class="deputy-header">
                        <div class="deputy-name">${deputy.nome}</div>
                        <div class="deputy-party">${deputy.partido}</div>
                    </div>
                    <div class="expense-total">${expenseDisplay}</div>
                    <div class="expense-details">${detailsDisplay}</div>
                `;

                card.style.cursor = 'pointer';
                card.addEventListener('click', () => this.showDeputyDetails(deputy));
            }

            showLoading() {
                document.getElementById('infinity-loading').style.display = 'flex';
                document.getElementById('manual-load-btn').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('infinity-loading').style.display = 'none';
                document.getElementById('manual-load-btn').style.display = 'block';
            }

            hideLoadMore() {
                document.getElementById('load-more-trigger').style.display = 'none';
            }

            updateLoadMoreButton() {
                const btn = document.getElementById('manual-load-btn');
                const remaining = this.filteredData.length - (this.currentPage * this.pageSize);

                if (remaining > 0) {
                    const nextBatch = Math.min(this.pageSize, remaining);
                    btn.textContent = `Carregar pr√≥ximos ${nextBatch} deputados (${remaining} restantes)`;
                    btn.disabled = false;
                } else {
                    btn.textContent = 'Todos os deputados foram carregados!';
                    btn.disabled = true;
                }
            }

            updateStats() {
                const loadedCount = this.loadedData.length;
                const withExpensesData = this.loadedData.filter(d => d.loaded && d.totalExpense > 0);
                const totalExpenses = withExpensesData.reduce((sum, d) => sum + d.totalExpense, 0);
                const avgExpense = withExpensesData.length > 0 ? totalExpenses / withExpensesData.length : 0;

                document.getElementById('loaded-count').textContent = loadedCount;
                document.getElementById('total-expenses').textContent = totalExpenses > 0 ? this.formatCurrency(totalExpenses) : '-';
                document.getElementById('avg-expense').textContent = avgExpense > 0 ? this.formatCurrency(avgExpense) : '-';

                // Update the expense chart
                this.renderExpenseChart();
            }

            renderExpenseChart() {
                const chartEl = document.getElementById('expense-chart');
                if (!chartEl) return;

                chartEl.innerHTML = '';

                // Get deputies with expenses for the bar chart
                const deputiesWithExpenses = this.loadedData.filter(d => d.loaded && d.totalExpense > 0);

                if (deputiesWithExpenses.length === 0) {
                    chartEl.innerHTML = '<p style="text-align: center; padding: 2rem; color: #64748b; font-size: 1.1rem;">üìä Carregue alguns deputados para ver a distribui√ß√£o de gastos</p>';
                    return;
                }

                // Sort by expense and show top spenders
                const topDeputies = deputiesWithExpenses
                    .sort((a, b) => b.totalExpense - a.totalExpense)
                    .slice(0, Math.min(15, deputiesWithExpenses.length)); // Show top 15 or all if less

                const margin = { top: 20, right: 30, bottom: 80, left: 100 };
                const width = chartEl.offsetWidth - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;

                const svg = d3.select(chartEl)
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom);

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Scales
                const xScale = d3.scaleBand()
                    .domain(topDeputies.map(d => d.nome.split(' ')[0]))
                    .range([0, width])
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(topDeputies, d => d.totalExpense)])
                    .range([height, 0]);

                // Bars
                g.selectAll('.bar')
                    .data(topDeputies)
                    .enter().append('rect')
                    .attr('class', 'bar')
                    .attr('x', d => xScale(d.nome.split(' ')[0]))
                    .attr('width', xScale.bandwidth())
                    .attr('y', d => yScale(d.totalExpense))
                    .attr('height', d => height - yScale(d.totalExpense))
                    .attr('fill', '#4f46e5')
                    .attr('opacity', 0.8)
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('opacity', 1);

                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'tooltip')
                            .style('position', 'absolute')
                            .style('background', 'rgba(0,0,0,0.9)')
                            .style('color', 'white')
                            .style('padding', '12px')
                            .style('border-radius', '8px')
                            .style('pointer-events', 'none')
                            .style('font-size', '14px')
                            .style('box-shadow', '0 4px 12px rgba(0,0,0,0.3)')
                            .style('z-index', '10000')
                            .html(`
                                <strong>${d.nome}</strong><br>
                                ${d.partido} - ${d.uf}<br>
                                Gasto: <strong>${scrollLoader.formatCurrency(d.totalExpense)}</strong><br>
                                ${d.expenseCount} despesas em 2025
                            `);

                        tooltip.style('left', (event.pageX + 10) + 'px')
                               .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('opacity', 0.8);
                        d3.selectAll('.tooltip').remove();
                    })
                    .on('click', function(event, d) {
                        scrollLoader.showDeputyDetails(d);
                    });

                // Axes
                g.append('g')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale))
                    .selectAll('text')
                    .style('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em')
                    .attr('transform', 'rotate(-45)')
                    .style('font-size', '12px');

                g.append('g')
                    .call(d3.axisLeft(yScale).tickFormat(d => this.formatCurrency(d)))
                    .style('font-size', '12px');

                // Labels
                g.append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 0 - margin.left)
                    .attr('x', 0 - (height / 2))
                    .attr('dy', '1em')
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('font-weight', '600')
                    .style('fill', '#374151')
                    .text('Valor Gasto (R$)');

                g.append('text')
                    .attr('transform', `translate(${width/2}, ${height + margin.bottom - 10})`)
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('font-weight', '600')
                    .style('fill', '#374151')
                    .text('Deputados (primeiros nomes)');

                // Add chart info
                g.append('text')
                    .attr('x', width - 10)
                    .attr('y', 15)
                    .attr('text-anchor', 'end')
                    .style('font-size', '12px')
                    .style('fill', '#6b7280')
                    .text(`Top ${topDeputies.length} de ${deputiesWithExpenses.length} deputados carregados`);
            }

            updatePerformanceIndicator() {
                const elapsedSeconds = (Date.now() - this.stats.startTime) / 1000;
                const requestsPerSecond = elapsedSeconds > 0 ? (this.stats.loaded / elapsedSeconds).toFixed(1) : '0';

                document.getElementById('perf-loaded').textContent = this.stats.loaded;
                document.getElementById('perf-with-expenses').textContent = this.stats.withExpenses;
                document.getElementById('perf-last-load').textContent = `${this.stats.lastLoadTime}ms`;
                document.getElementById('perf-speed').textContent = `${requestsPerSecond} req/s`;
            }

            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }

            showDeputyDetails(deputy) {
                const details = `
Deputado: ${deputy.nome}
Partido: ${deputy.partido} - ${deputy.uf}
Gasto Total em 2025: ${this.formatCurrency(deputy.totalExpense)}
N√∫mero de Despesas: ${deputy.expenseCount}
Voto na PEC: ${deputy.voto || 'N√£o registrado'}
                `;
                alert(details);
            }

            showError(message) {
                const grid = document.getElementById('deputy-grid');
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Erro</h3>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        // Initialize the smart loader
        let scrollLoader;

        document.addEventListener('DOMContentLoaded', async () => {
            scrollLoader = new ScrollExpenseLoader();
            await scrollLoader.initialize();
        });
    </script>
</body>
</html>